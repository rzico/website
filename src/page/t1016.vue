<template>
  <div class="main-box">
    <div class="main-box">
      <div class="root meipian" data-mask-id="199a3fb6">
        <article_cover></article_cover>
        <div class="music-icon__root"><div play="" class="music-icon"><audio id="audio" controls="controls" loop="loop" src="https://ss2.meipian.me/music/LingErDingDang.m4a" style="display: none;"></audio> <i class="iconfont icon-music"></i></div></div>
        <div class="content_foot">
          <div class="mp-content">
            <div class="well content-container"><div class="section"><div class="img-box offline-preview xiushi1"><img show-img="https://ss2.meipian.me/users/12119279/6b1ea1a5ae104903ba3121082984e623.jpg?meipian-raw/bucket/ivwen/key/dXNlcnMvMTIxMTkyNzkvNmIxZWExYTVhZTEwNDkwM2JhMzEyMTA4Mjk4NGU2MjMuanBn/sign/4589a42e8ba9dea7c989652d39e86fc0.jpg" src="https://ss2.meipian.me/users/12119279/6b1ea1a5ae104903ba3121082984e623.jpg-mobile"></div> <div class="text"><h3>哪里来的图</h3></div></div> <div class="section"><div class="img-box offline-preview xiushi2"><img show-img="https://ss2.meipian.me/users/12119279/17aedff258bc4078bd7876e5345e4e74.jpg?meipian-raw/bucket/ivwen/key/dXNlcnMvMTIxMTkyNzkvMTdhZWRmZjI1OGJjNDA3OGJkNzg3NmU1MzQ1ZTRlNzQuanBn/sign/ca560812f36dd1b2e89045a470329f06.jpg" src="https://ss2.meipian.me/users/12119279/17aedff258bc4078bd7876e5345e4e74.jpg-mobile"></div></div> <div class="section"><div class="img-box offline-preview xiushi1"><img show-img="https://ss2.meipian.me/users/12119279/fe7764816f48446a8e796796eae88e4a.jpg?meipian-raw/bucket/ivwen/key/dXNlcnMvMTIxMTkyNzkvZmU3NzY0ODE2ZjQ4NDQ2YThlNzk2Nzk2ZWFlODhlNGEuanBn/sign/f7289aec2d72f950510b313f23ff7082.jpg" src="https://ss2.meipian.me/users/12119279/fe7764816f48446a8e796796eae88e4a.jpg-mobile"></div> <div class="text"><h3>手机上的图</h3></div></div> <div class="section"><div class="img-box offline-preview xiushi2"><img show-img="https://ss2.meipian.me/users/12119279/13301d38b6234551a27f69619a4c08c8.jpg?meipian-raw/bucket/ivwen/key/dXNlcnMvMTIxMTkyNzkvMTMzMDFkMzhiNjIzNDU1MWEyN2Y2OTYxOWE0YzA4YzguanBn/sign/aca646d3230eae55aba4ea97c7426533.jpg" src="https://ss2.meipian.me/users/12119279/13301d38b6234551a27f69619a4c08c8.jpg-mobile"></div> <div class="text"><h3>www菩提log秃鹫</h3></div></div> <div class="section"><div class="img-box offline-preview xiushi1"><img show-img="https://ss2.meipian.me/users/12119279/0f68dda15daa4267bd735c5a3be31ec3.jpg?meipian-raw/bucket/ivwen/key/dXNlcnMvMTIxMTkyNzkvMGY2OGRkYTE1ZGFhNDI2N2JkNzM1YzVhM2JlMzFlYzMuanBn/sign/e1cd50b3b8d53cec6a9ba6686f8513e1.jpg" src="https://ss2.meipian.me/users/12119279/0f68dda15daa4267bd735c5a3be31ec3.jpg-mobile"></div></div> <div class="section"><div class="img-box offline-preview xiushi2"><img show-img="https://ss2.meipian.me/users/12119279/fa41b5dc11524ab396fa9299e0f68ea6.jpg?meipian-raw/bucket/ivwen/key/dXNlcnMvMTIxMTkyNzkvZmE0MWI1ZGMxMTUyNGFiMzk2ZmE5Mjk5ZTBmNjhlYTYuanBn/sign/9b9a462b04aabe159428751a1204b823.jpg" src="https://ss2.meipian.me/users/12119279/fa41b5dc11524ab396fa9299e0f68ea6.jpg-mobile"></div></div> <div class="section"><div class="img-box offline-preview xiushi1"><img show-img="https://ss2.meipian.me/users/12119279/25bf0b3744a645f883b59f5e83b56c9b.jpg?meipian-raw/bucket/ivwen/key/dXNlcnMvMTIxMTkyNzkvMjViZjBiMzc0NGE2NDVmODgzYjU5ZjVlODNiNTZjOWIuanBn/sign/6ccf145ad57897a92396591020955a46.jpg" src="https://ss2.meipian.me/users/12119279/25bf0b3744a645f883b59f5e83b56c9b.jpg-mobile"></div> <div class="text"><h3>swing随机VPN住</h3></div></div></div>
            <div class="readmore" style="display: none;">
              <a href="javascript:;">
                <div>展开阅读全文</div>
                <i class="iconfont icon-arrow"></i>
              </a>
            </div>

          </div>
          <div class="footer__root"><!----> <div class="report" red-packet-type=""><div class="well">
            阅读 <span class="read-count">40</span> <!----> <a class="btn-report">举报</a></div></div> <!----> <!----> <div id="comment"><div class="comment" red-packet-type=""><div class="footer-section"><div class="well"><h3 class="title">热门评论<span>(2)</span></h3> <div><div><div class="comment-item" indec="0"><!----> <div class="comment-box"><div class="avatar-box"><img src="http://static2.ivwen.com/users/12119279/17fed1c168af4363ab485aef9b5c74b8.jpg" alt="" class="avatar"> <!----></div> <a class="btn-admire"><i class="iconfont icon-zan"></i> <span class="admire-count">0</span></a> <h4 class="nickname line-clamp-1"><span>柯志杰了他他</span></h4> <div><p class=" comment-detail line-clamp-6">呵呵</p> <p class="all-content" style="display: none;">全文</p></div> <!----> <span class="comment-time">04-24</span></div> <!----></div><div indec="1" class="comment-item"><!----> <div class="comment-box"><div class="avatar-box"><img src="http://static2.ivwen.com/users/12119279/17fed1c168af4363ab485aef9b5c74b8.jpg" alt="" class="avatar"> <!----></div> <a class="btn-admire"><i class="iconfont icon-zan"></i> <span class="admire-count">0</span></a> <h4 class="nickname line-clamp-1"><span>柯志杰了他他</span></h4> <div><p class=" comment-detail line-clamp-6">哈哈哈</p> <p class="all-content" style="display: none;">全文</p></div> <!----> <span class="comment-time">04-24</span></div> <div class="more"><div><!----> <!----> <a class="btn btn-block btn-comment">打开美篇查看全部评论</a></div></div></div></div></div></div></div></div></div> <div class="qrcode-banner"><div class="footer-section"><img src="https://ss2.meipian.me/config/1518853571370.jpg" alt=""></div></div> <div class="recommend"><div class="footer-section"><div class="well"><h3 class="title">推荐文章</h3> <div href="https://mp.weixin.qq.com/s/NtPXy8CiW5k19YvmhYHMTA" class="recommend-item clearfix"><a><div class="img-container"><img alt="妈妈和女友落水先救谁？这道世纪难题终于有答案了......" src="http://static2.ivwen.com/config/1524891006296.jpg" lazy="loaded"></div> <h4 class="article-title line-clamp-2">妈妈和女友落水先救谁？这道世纪难题终于有答案了......</h4> <p class="view-count"><i class="iconfont icon-yuedu"></i> <span class="count">211387</span></p></a></div><div href="https://hy.yixueqm.com/zhiming/index.php/Home-Bzjp-index?channel=qudao19" class="recommend-item clearfix"><a><div class="img-container"><img alt="你的农历生日是哪天？注定你是个什么样的人！太准了！" src="http://static2.ivwen.com/config/1524733074481.jpg" lazy="loaded"></div> <h4 class="article-title line-clamp-2">你的农历生日是哪天？注定你是个什么样的人！太准了！</h4> <p class="view-count"><i class="iconfont icon-yuedu"></i> <span class="count">415081</span></p></a></div><div href="https://mp.weixin.qq.com/s/fvt4Qud7wKOTAoI4fxsO_w" class="recommend-item clearfix"><a><div class="img-container"><img alt="男子中500万瞒着老婆，离婚第二天就兑奖，结果傻眼了……" src="http://static2.ivwen.com/config/1524801682324.jpg" lazy="loaded"></div> <h4 class="article-title line-clamp-2">男子中500万瞒着老婆，离婚第二天就兑奖，结果傻眼了……</h4> <p class="view-count"><i class="iconfont icon-yuedu"></i> <span class="count">108819</span></p></a></div> <div class="recommend-item clearfix"><a href="javascript:;"><div class="img-container"><img src="https://ss2.meipian.me/config/160ee8dcb6a16cb85d669c9478fa0d01.jpg" alt="女人为什么要丰胸？看完99%都顿悟了!"></div> <h4 class="article-title line-clamp-2">女人为什么要丰胸？看完99%都顿悟了!</h4> <p class="view-count"><img src="https://ss2.meipian.me/theme/v2/ads/advert.png" alt="" style="height: 17px;"></p></a> <!----></div> <div href="https://www.meipian.cn/19cxog82" class="recommend-item clearfix"><a><div class="img-container"><img alt="五一小长假的四种度过方式" src="http://static2.ivwen.com/user/10004/c7f648713b600001c79c151b1c907d60.jpg" lazy="loaded"></div> <h4 class="article-title line-clamp-2">五一小长假的四种度过方式</h4> <p class="view-count"><i class="iconfont icon-yuedu"></i> <span class="count">5617</span></p></a></div><div href="https://www.meipian.cn/140u70pn" class="recommend-item clearfix"><a><div class="img-container"><img alt="梅花三弄，美醉了！" src="https://ss2.meipian.me/users/15906749/33df7071db134951855b3cc555998e59.jpg-mobile" lazy="loaded"></div> <h4 class="article-title line-clamp-2">梅花三弄，美醉了！</h4> <p class="view-count"><i class="iconfont icon-yuedu"></i> <span class="count">171007</span></p></a></div><div href="https://www.meipian.cn/19931633" class="recommend-item clearfix"><a><div class="img-container"><img alt="身体下地狱，灵魂上天堂" src="https://ss2.meipian.me/users/1793451/3fa96241a4de4faaab6c8e01460e48b0.jpg-mobile" lazy="loaded"></div> <h4 class="article-title line-clamp-2">身体下地狱，灵魂上天堂</h4> <p class="view-count"><i class="iconfont icon-yuedu"></i> <span class="count">16942</span></p></a></div><div href="https://www.meipian.cn/130nljw2" class="recommend-item clearfix"><a><div class="img-container"><img alt="江山如画，大美中华" src="https://ss2.meipian.me/users/615709/54fce6e3c5874cebbf5ee6c672d19eef.jpg-mobile" lazy="loaded"></div> <h4 class="article-title line-clamp-2">江山如画，大美中华</h4> <p class="view-count"><i class="iconfont icon-yuedu"></i> <span class="count">189144</span></p></a></div></div></div></div> <div class="introduce-meipian"><a><img src="https://ss2.meipian.me/config/1518517606552.jpg" alt="你好，我是小美"></a></div> <div></div> <div></div></div>
        </div>
        <div id="rcmd-ads">
        </div>
        <div id="commercial-ads">
        </div>
      </div>
    </div>
  </div>

</template>
<style>
  @import "../less/t1016.less";
</style>

<script>
  import {Loadmore} from 'mint-ui';
  import { POST,GET,AUTH,SHARE} from '../assets/fetch.js';
  import utils from '../assets/utils.js';
  import download_bar from './article/download_bar.vue';
  import article_meta from './article/t1002/meta.vue';
  import article_cover from './article/t1016/cover.vue';
  import music from './article/music.vue';
  import article_content from './article/content.vue';
  import vote from './article/vote.vue';
  import reward from './article/reward.vue';
  import report from './article/report.vue';
  import coupon from './article/t1002/coupon.vue';
  import auther from './article/auther.vue';
  import recommend from './article/recommend.vue';
  import review from './article/review.vue';
  import ad from './article/ad.vue';
  import rewardDialog from './article/rewardDialog.vue';
  import Toast from '../widget/toast.vue';
  import payment from '../widget/payment.vue';
  import buyGoods from '../widget/buyGoods.vue';
  import card from './member/card.vue';
  import getCoupon from './coupon/activate.vue';
  import Dialog from '../widget/dialog.vue';
  //  import Dialog from '../widget/dialog.vue';
  export default {
    data () { return {
      logined:false,
      msg:"",
      watchTemplates: this.templates,
      watchMusicData: this.musicData,
      watchArticle: this.article,
      downloadShow:true,
      musicPlay:0,
      noWeex:true,
      isPublish:true,
//      payWay:'账户余额',
//      payPrice:'299',
      sn:'',
    }
    },
    components: {
      'v-loadmore':Loadmore, // 为组件起别名，vue转换template标签时不会区分大小写，例如：loadMore这种标签转换完就会变成loadmore，容易出现一些匹配问题
      Toast,
      download_bar,
      article_meta,
      music,
      article_content,
      reward,
      report,
      coupon,
      auther,
      recommend,
      review,
      ad,
      rewardDialog,
      payment,
      vote,
      card,
      buyGoods,
      article_cover
//      'weui-dialog':Dialog,
    },
    props: {
      article: { default: function () {
        return {hits:0,title:"样例",nickName:"author",createDate:null,member:{autograph:""}}
      }
      },
      musicData: { default: function () {
        return {id: "-1"}
      }
      },
      templates: { default: function () {
        return []
      }
      },
      htmlStr :{default:""},
    },
    created() {
      var _this = this;
      AUTH("",function (authed) {
        _this.logined  = authed;
      })
      if(utils.isweex()==true){
        this.downloadShow = false;
        this.noWeex = false;
      }
      let id = utils.getUrlParameter("id");
      this.go(id);
    },
    methods: {
      loadTop:function() { //组件提供的下拉触发方法
        this.$refs.loadmore.onTopLoaded();// 固定方法，查询完要调用一次，用于重新定位
      },
      loadBottom:function() {
        this.$refs.loadmore.onBottomLoaded();// 固定方法，查询完要调用一次，用于重新定位
      },
      onPayNotify:function (data) {
        if ("success"==data.type) {
        } else {
          this.$refs.toast.show(data.content);
        }
      },
      fetchData:function (id) {
        this.go(id);
        this.$refs.review.open(id);
        this.$refs.cardImg.open(id);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      },
      go:function (id) {
        var _this = this;
        GET('website/article/view.jhtml?id='+id).then(
          function (response) {
            if (response.type=="success") {
              _this.watchArticle = response.data;
              _this.isPublish = response.data.isPublish;
              _this.$refs.coupon.open(response.data.member.id);
              //设置分享标题
              utils.setConfig({
                title:_this.watchArticle.title,
                desc:_this.watchArticle.htmlTag,
                link:_this.watchArticle.url,
                thumbnail:_this.watchArticle.thumbnail
              });
              SHARE(location.href);
              if (!utils.isNull(response.data.music)) {
                _this.watchMusicData = JSON.parse(response.data.music);
              }
              if (!utils.isNull(response.data.templates)) {
                if (response.data.mediaType==0) {
                  _this.htmlStr = response.data.templates;
                } else {
//                  图片预览
                  var previewList = [];
                  response.data.templates.forEach(function (item) {
                    if(item.mediaType == 'product'){
                      GET('website/article/goods.jhtml?id=' + item.id).then(
                        function (data) {
                          if(data.type == 'success'){
//                           对数组对象进行操作需要 这样子才能重新渲染界面
                            _this.$set(item, 'name', data.data.name);
                            _this.$set(item, 'price', data.data.price);
                          }else{
                            _this.$refs.toast.show("服务器繁忙");
                          }
                        },function (err) {
                          _this.$refs.toast.show("网络不稳定");
                        }
                      )
                    }
//                    图片预览
                    if(item.mediaType == 'product' || item.mediaType == 'image' && !utils.isNull(item.original)){
                      previewList.push({
                        src: utils.filterThumbnail(item.original),
                        w: 900,
                        h: 1000
                      })
                    }
                  })
                  _this.$set(response.data.templates, 'previewList', previewList);
                  _this.watchTemplates = response.data.templates;
                }
              }

            } else {
              _this.$refs.toast.show("网络不稳定");
//                 _this.$refs.toast.show('website/article/view.jhtml?id='+id);
            }
          }, function () {
            _this.$refs.toast.show("网络不稳定");
//                _this.$refs.toast.show('ssssswebsite/article/view.jhtml?id='+id);

          });
      },
      showRewardDialog:function () {
        this.$refs.rwd.show();
      },
      rewardNumber:function (m) {
        var _this = this;
        _this.$refs.toast.loading();
        if(utils.isweex()==true){
          _this.$refs.toast.show('请分享到微信进行赞赏');
          return;
        }
        POST("website/member/reward/submit.jhtml?amount="+m+"&articleId="+_this.watchArticle.id).then(
          function (data) {
            if (data.type=="success") {
              _this.$router.push({
                name: "payment",
                query: {psn: data.data, amount:m,type:'weixin'}
              });
            } else {

            }
          },
          function (err) {
            _this.$refs.toast.hide();
            _this.$refs.toast.show("网络不稳定");
          }
        )
      },
      weixin:function(sn) {
        var _this = this;
//        weixinOcPayPlugin    weixinPayPlugin
        POST("payment/submit.jhtml?sn="+sn+"&paymentPluginId=weixinOcPayPlugin").then(
          function (res) {
            console.log(res)
            if (res.type=="success") {
              let jsApiCall = function () {
                WeixinJSBridge.invoke('getBrandWCPayRequest',{
                  "appId" : res.data.appId,
                  "timeStamp":res.data.timeStamp,
                  "nonceStr" :res.data.nonceStr,
                  "package" :res.data.package,
                  "signType" :res.data.signType,
                  "paySign" : res.data.paySign,
                },function(result){
                  if(result.err_msg == "get_brand_wcpay_request:ok" ) {

                    setTimeout(function () {
                      _this.$refs.reward.open()
                    },2000)
                  } else {
                    _this.$refs.toast.show("支付取消");
//                  _this.$refs.toast.show(result.memo);
                  }
                });
              }
              if (typeof WeixinJSBridge == "undefined") {
                if (document.addEventListener) {
                  document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
                } else if (document.attachEvent) {
                  document.attachEvent('WeixinJSBridgeReady', jsApiCall);
                  document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
                }
              } else {
                jsApiCall();
              }
            }
            else {

//              _this.pageIcon = 'cancel';
              _this.$refs.toast.show("网络不稳定");
            }
          },
          function (err) {

            _this.$refs.toast.show("网络不稳定");
          }
        )
      },
      closeDownload:function () {//关闭顶部下载组件。并控制页面上移
        this.downloadShow = false;
      },
      onscroll(e){
        if(this.musicPlay == 0){//控制判断音乐。来判断从未触发音乐时滚动触发音乐，而在触发过音乐后滚动时不触发音乐事件。
          this.musicPlay = 1;
          this.$refs.musicTemplete.openPlayer();
        }
      },
      judgeMusic:function () {//控制判断音乐。来判断从未触发音乐时滚动触发音乐，而在触发过音乐后滚动时不触发音乐事件。
        this.musicPlay = 1;
      },
      buyNow:function (id) {
        if(utils.isweex()==true){

//          location.href =  'mopian://buyGood?id=' + id;
          this.$refs.toast.show('请分享到微信进行购买!');
          return;
        }

        let _this = this;
        AUTH(location.href,function (authed) {
          if (authed) {
            _this.$refs.buy.show(id,_this.watchArticle.id);
          }
        })

      },
      onscroll(e){
        if(this.musicPlay == 0){//控制判断音乐。来判断从未触发音乐时滚动触发音乐，而在触发过音乐后滚动时不触发音乐事件。
          this.musicPlay = 1;
          this.$refs.musicTemplete.openPlayer();
        }
      },
//      payConfirm:function (payInfo) {
//        alert(payInfo);
//        payInfo = JSON.parse(payInfo);
//        this.payWay = payInfo.way;
//        this.payPrice = payInfo.price;
//        this.sn = payInfo.sn;
//        this.$refs.dialog.show();
//      },
    }
  }

</script>
